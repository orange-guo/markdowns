"use strict";(self.webpackChunkmarkdowns=self.webpackChunkmarkdowns||[]).push([[5802],{86494:(e,a,n)=>{n.r(a),n.d(a,{assets:()=>i,contentTitle:()=>s,default:()=>h,frontMatter:()=>t,metadata:()=>r,toc:()=>d});var r=n(39988),l=n(74848),c=n(28453);const t={authors:["orange"],tags:["troubleshooting","guacamole","guacamole-server","guacd","ssh","linux","terminal","c","pthread","pthread_key"]},s="\u89e3\u51b3Apache Guacamole\u4e2dSSH\u8fde\u63a5\u6570\u91cf\u8d85\u8fc760\u4e2a\u4ee5\u540e\u65e0\u6cd5\u5efa\u7acb\u65b0\u8fde\u63a5\u7684\u95ee\u9898",i={authorsImageUrls:[void 0]},d=[{value:"\u95ee\u9898\u63cf\u8ff0",id:"\u95ee\u9898\u63cf\u8ff0",level:2},{value:"\u95ee\u9898\u5206\u6790",id:"\u95ee\u9898\u5206\u6790",level:2},{value:"\u89e3\u51b3\u65b9\u6848",id:"\u89e3\u51b3\u65b9\u6848",level:2},{value:"\u4ee3\u7801\u5b9e\u73b0",id:"\u4ee3\u7801\u5b9e\u73b0",level:2},{value:"\u7ebf\u7a0b\u672c\u5730\u5b58\u50a8API (thread-local.h)",id:"\u7ebf\u7a0b\u672c\u5730\u5b58\u50a8api-thread-localh",level:3},{value:"2.2 \u54c8\u5e0c\u8868\u5b9e\u73b0 (thread-local.c)",id:"22-\u54c8\u5e0c\u8868\u5b9e\u73b0-thread-localc",level:3},{value:"2.3 \u9519\u8bef\u5904\u7406\u4f18\u5316 (error.c)",id:"23-\u9519\u8bef\u5904\u7406\u4f18\u5316-errorc",level:3},{value:"\u6548\u679c\u9a8c\u8bc1",id:"\u6548\u679c\u9a8c\u8bc1",level:2},{value:"\u6784\u5efa\u4e0e\u73af\u5883\u914d\u7f6e",id:"\u6784\u5efa\u4e0e\u73af\u5883\u914d\u7f6e",level:2},{value:"\u76f8\u5173\u8d44\u6e90",id:"\u76f8\u5173\u8d44\u6e90",level:2}];function o(e){const a={a:"a",code:"code",h2:"h2",h3:"h3",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,c.R)(),...e.components};return(0,l.jsxs)(l.Fragment,{children:[(0,l.jsx)(a.h2,{id:"\u95ee\u9898\u63cf\u8ff0",children:"\u95ee\u9898\u63cf\u8ff0"}),"\n",(0,l.jsxs)(a.p,{children:["\u5728\u4f7f\u7528 ",(0,l.jsx)(a.code,{children:"Apache Guacamole"})," \u5efa\u7acb\u5927\u91cf\u5e76\u53d1 SSH \u8fde\u63a5\u65f6\uff0c\u5f53\u8fde\u63a5\u6570\u8d85\u8fc760\u4e2a\uff0c\u65b0\u7684 SSH \u8fde\u63a5\u5c06\u65e0\u6cd5\u5efa\u7acb\u3002\n",(0,l.jsx)(a.code,{children:"guacd"})," \u670d\u52a1\u7684\u65e5\u5fd7\u4f1a\u8f93\u51fa\u4ee5\u4e0b\u5173\u952e\u9519\u8bef\u3002"]}),"\n",(0,l.jsx)(a.pre,{children:(0,l.jsx)(a.code,{className:"language-log",children:'guacd[1]: INFO: Creating new client for protocol "ssh"\nguacd[1]: INFO: Connection ID is "$9ab9b061-a1ae-4a18-b56a-83202fa22b5c"\nguacd[3882]: INFO:      User "@fc5e98ea-74ab-49c9-9b06-c3206469cab0" joined connection "$9ab9b061-a1ae-4a18-b56a-83202fa22b5c" (1 users now present)\nGLib (gthread-posix.c): Unexpected error from C library during \'pthread_key_create\': Resource temporarily unavailable.  Aborting.\nguacd[3882]: ERROR:     SSH handshake failed.\nguacd[3882]: INFO:      User "@fc5e98ea-74ab-49c9-9b06-c3206469cab0" disconnected (0 users remain)\nguacd[3882]: INFO:      Last user of connection "$9ab9b061-a1ae-4a18-b56a-83202fa22b5c" disconnected\nguacd[1]: INFO: Connection "$9ab9b061-a1ae-4a18-b56a-83202fa22b5c" removed.\n'})}),"\n",(0,l.jsx)(a.h2,{id:"\u95ee\u9898\u5206\u6790",children:"\u95ee\u9898\u5206\u6790"}),"\n",(0,l.jsxs)(a.p,{children:["\u9519\u8bef\u65e5\u5fd7\u4e2d\u7684\u6838\u5fc3\u4fe1\u606f ",(0,l.jsx)(a.code,{children:"pthread_key_create': Resource temporarily unavailable"})," \u6307\u5411\u4e86\u95ee\u9898\u7684\u6839\u6e90\uff1aguacd \u8fdb\u7a0b\u8017\u5c3d\u4e86\u7cfb\u7edf\u4e3a\u5176\u5206\u914d\u7684\npthread_key_t \u8d44\u6e90\u3002"]}),"\n",(0,l.jsx)(a.p,{children:"glibc \u5bf9\u6bcf\u4e2a\u8fdb\u7a0b\u53ef\u521b\u5efa\u7684 pthread_key_t \u6570\u91cf\u8bbe\u6709\u4e0a\u9650\uff0c\u8fd9\u4e2a\u4e0a\u9650\u503c\u901a\u5e38\u662f 1024\u3002"}),"\n",(0,l.jsx)(a.pre,{children:(0,l.jsx)(a.code,{className:"language-bash",children:"getconf PTHREAD_KEYS_MAX # 1024\n"})}),"\n",(0,l.jsx)(a.h2,{id:"\u89e3\u51b3\u65b9\u6848",children:"\u89e3\u51b3\u65b9\u6848"}),"\n",(0,l.jsx)(a.p,{children:"\u7531\u4e8e PTHREAD_KEYS_MAX \u7684\u9650\u5236\u786c\u7f16\u7801\u4e8e glibc \u6e90\u7801\u4e2d\uff0c\u6211\u4eec\u65e0\u6cd5\u901a\u8fc7\u4fee\u6539\u7cfb\u7edf\u914d\u7f6e\u6765\u8c03\u6574\u6b64\u4e0a\u9650\u3002"}),"\n",(0,l.jsx)(a.p,{children:"\u4e3a\u4e86\u7ed5\u8fc7\u8fd9\u4e00\u9650\u5236\uff0c\u51b3\u5b9a\u653e\u5f03 pthread_key\uff0c\u8f6c\u800c\u5b9e\u73b0\u4e00\u5957\u81ea\u5b9a\u4e49\u7684\u3001\u66f4\u9ad8\u6548\u7684\u7ebf\u7a0b\u672c\u5730\u5b58\u50a8\uff08Thread-Local Storage, TLS\uff09\u673a\u5236\u3002"}),"\n",(0,l.jsx)(a.p,{children:(0,l.jsx)(a.strong,{children:"\u6df7\u5408\u5b58\u50a8\u7b56\u7565\uff1a"})}),"\n",(0,l.jsxs)(a.ul,{children:["\n",(0,l.jsx)(a.li,{children:"\u76f4\u63a5 __thread \u5b58\u50a8\uff1a\u5bf9\u4e8e\u9519\u8bef\u5904\u7406\u7b49\u9891\u7e41\u8bbf\u95ee\u7684\u7b80\u5355\u573a\u666f\uff0c\u76f4\u63a5\u4f7f\u7528 __thread \u5173\u952e\u5b57\u58f0\u660e\u7ebf\u7a0b\u672c\u5730\u53d8\u91cf\uff0c\u4ee5\u83b7\u5f97\u6781\u81f4\u6027\u80fd\u3002"}),"\n",(0,l.jsx)(a.li,{children:"\u57fa\u4e8e\u54c8\u5e0c\u8868\u7684\u5b58\u50a8\uff1a\u5bf9\u4e8e\u9700\u8981\u652f\u6301\u6790\u6784\u51fd\u6570\u3001\u52a8\u6001 key \u5206\u914d\u7684\u590d\u6742\u573a\u666f\uff0c\u5b9e\u73b0\u4e86\u4e00\u4e2a\u7ebf\u7a0b\u5b89\u5168\u7684\u54c8\u5e0c\u8868\u4f5c\u4e3a\u540e\u7aef\u3002"}),"\n"]}),"\n",(0,l.jsx)(a.p,{children:(0,l.jsx)(a.strong,{children:"\u517c\u5bb9\u7684 API \u63a5\u53e3\uff1a"})}),"\n",(0,l.jsx)(a.p,{children:"\u4e3a\u4e86\u6700\u5c0f\u5316\u5bf9\u73b0\u6709\u4ee3\u7801\u5e93\u7684\u4fb5\u5165\u6027\uff0c\u65b0\u5b9e\u73b0\u7684 API \u5728\u51fd\u6570\u7b7e\u540d\u4e0a\u4e0e\u539f\u6709\u7684 pthread \u51fd\u6570\u9ad8\u5ea6\u517c\u5bb9\uff0c\u4fbf\u4e8e\u5e73\u6ed1\u8fc1\u79fb\u3002"}),"\n",(0,l.jsx)(a.pre,{children:(0,l.jsx)(a.code,{className:"language-c",children:"#include <pthread.h>\n\nint pthread_key_create(pthread_key_t *key, typeof(void (void *)) *destr_function;\nint pthread_key_delete(pthread_key_t key);\nint pthread_setspecific(pthread_key_t key, const void *pointer);\nvoid * pthread_getspecific(pthread_key_t key);\n"})}),"\n",(0,l.jsx)(a.h2,{id:"\u4ee3\u7801\u5b9e\u73b0",children:"\u4ee3\u7801\u5b9e\u73b0"}),"\n",(0,l.jsx)(a.h3,{id:"\u7ebf\u7a0b\u672c\u5730\u5b58\u50a8api-thread-localh",children:"\u7ebf\u7a0b\u672c\u5730\u5b58\u50a8API (thread-local.h)"}),"\n",(0,l.jsx)(a.pre,{children:(0,l.jsx)(a.code,{className:"language-c",children:"typedef uintptr_t guac_thread_local_key_t;\ntypedef void (*guac_thread_local_destructor_t)(void*);\n\nint guac_thread_local_key_create(guac_thread_local_key_t* key, guac_thread_local_destructor_t destructor);\nint guac_thread_local_key_delete(guac_thread_local_key_t key);\nint guac_thread_local_setspecific(guac_thread_local_key_t key, const void* value);\nvoid* guac_thread_local_getspecific(guac_thread_local_key_t key);\n"})}),"\n",(0,l.jsx)(a.h3,{id:"22-\u54c8\u5e0c\u8868\u5b9e\u73b0-thread-localc",children:"2.2 \u54c8\u5e0c\u8868\u5b9e\u73b0 (thread-local.c)"}),"\n",(0,l.jsxs)(a.ul,{children:["\n",(0,l.jsx)(a.li,{children:"\u6700\u5927\u652f\u6301 1024 \u4e2a key\uff08\u53ef\u914d\u7f6e\uff09"}),"\n",(0,l.jsx)(a.li,{children:"\u4f7f\u7528 __thread \u5173\u952e\u5b57\u63d0\u4f9b\u66f4\u597d\u7684\u6027\u80fd"}),"\n",(0,l.jsx)(a.li,{children:"\u5168\u5c40 key \u6ce8\u518c\u8868\uff0c\u652f\u6301\u6790\u6784\u51fd\u6570"}),"\n",(0,l.jsx)(a.li,{children:"\u7ebf\u7a0b\u5b89\u5168\uff0c\u4f7f\u7528 mutex \u4fdd\u62a4\u5171\u4eab\u6570\u636e\u7ed3\u6784"}),"\n"]}),"\n",(0,l.jsx)(a.pre,{children:(0,l.jsx)(a.code,{className:"language-c",children:"#define MAX_THREAD_KEYS 1024\n\ntypedef struct guac_thread_storage {\n    void* values[MAX_THREAD_KEYS];\n} guac_thread_storage_t;\n\nstatic __thread guac_thread_storage_t* thread_storage = NULL;\n"})}),"\n",(0,l.jsx)(a.h3,{id:"23-\u9519\u8bef\u5904\u7406\u4f18\u5316-errorc",children:"2.3 \u9519\u8bef\u5904\u7406\u4f18\u5316 (error.c)"}),"\n",(0,l.jsx)(a.p,{children:"\u5c06\u9519\u8bef\u5904\u7406\u4ece pthread key \u6539\u4e3a\u76f4\u63a5\u4f7f\u7528 __thread \u5b58\u50a8\uff0c\u83b7\u5f97\u6700\u4f73\u6027\u80fd\uff1a"}),"\n",(0,l.jsx)(a.pre,{children:(0,l.jsx)(a.code,{className:"language-c",children:"static __thread guac_status __guac_error_storage;\nstatic __thread const char* __guac_error_message_storage = NULL;\n\nguac_status* __guac_error() {\n    return &__guac_error_storage;\n}\n\nconst char** __guac_error_message() {\n    return &__guac_error_message_storage;\n}\n"})}),"\n",(0,l.jsx)(a.h2,{id:"\u6548\u679c\u9a8c\u8bc1",children:"\u6548\u679c\u9a8c\u8bc1"}),"\n",(0,l.jsx)(a.p,{children:"\u5728\u5e94\u7528\u4e0a\u8ff0\u4ee3\u7801\u4fee\u6539\u5e76\u91cd\u65b0\u7f16\u8bd1 guacd \u540e\uff0c\u8fdb\u884c\u4e86\u538b\u529b\u6d4b\u8bd5\u3002\u901a\u8fc7\u4ee5\u4e0b\u811a\u672c\u6a21\u62df\u4e86 300 \u4e2a\u5e76\u53d1\u8fde\u63a5\u8bf7\u6c42\uff1a"}),"\n",(0,l.jsx)(a.pre,{children:(0,l.jsx)(a.code,{className:"language-bash",children:"for i in $(seq 1 300); do\n  firefox --new-tab 'https://localhost:8443/#/client/MQBjAHBvc3RncmVzcWw' &\n  sleep 0.1s\ndone\n"})}),"\n",(0,l.jsx)(a.p,{children:"\u6d4b\u8bd5\u7ed3\u679c\u8868\u660e\uff0c\u65b0\u5b9e\u73b0\u53ef\u4ee5\u7a33\u5b9a\u5904\u7406\u8d85\u8fc7 300 \u4e2a\u5e76\u53d1\u8fde\u63a5\uff0c\u672a\u51fa\u73b0\u4efb\u4f55\u8fde\u63a5\u5931\u8d25\u7684\u60c5\u51b5\uff0c\u95ee\u9898\u5f97\u5230\u89e3\u51b3\u3002"}),"\n",(0,l.jsx)(a.h2,{id:"\u6784\u5efa\u4e0e\u73af\u5883\u914d\u7f6e",children:"\u6784\u5efa\u4e0e\u73af\u5883\u914d\u7f6e"}),"\n",(0,l.jsx)(a.p,{children:"\u4ee5\u4e0b\u662f\u5728 Arch Linux \u73af\u5883\u4e0b\u7f16\u8bd1\u548c\u8fd0\u884c\u6b64\u89e3\u51b3\u65b9\u6848\u7684\u53c2\u8003\u6b65\u9aa4\u3002"}),"\n",(0,l.jsxs)(a.ol,{children:["\n",(0,l.jsx)(a.li,{children:"\u4f9d\u8d56\u5b89\u88c5"}),"\n"]}),"\n",(0,l.jsx)(a.pre,{children:(0,l.jsx)(a.code,{className:"language-bash",children:"# \u5b89\u88c5\u6d4b\u8bd5\u6846\u67b6\u4f9d\u8d56\nyay -S --noconfirm --needed cunit\n\n# \u5b89\u88c5 SSH \u76f8\u5173\u4f9d\u8d56\nyay -S --noconfirm --needed libssh2 openssl pango\n"})}),"\n",(0,l.jsxs)(a.ol,{start:"2",children:["\n",(0,l.jsx)(a.li,{children:"\u9879\u76ee\u914d\u7f6e"}),"\n"]}),"\n",(0,l.jsx)(a.pre,{children:(0,l.jsx)(a.code,{className:"language-bash",children:"autoreconf -fiv\n./configure 'CPPFLAGS=-Wno-error=deprecated-declarations'\n"})}),"\n",(0,l.jsxs)(a.ol,{start:"3",children:["\n",(0,l.jsx)(a.li,{children:"\u4ee3\u7801\u7f16\u8bd1"}),"\n"]}),"\n",(0,l.jsx)(a.pre,{children:(0,l.jsx)(a.code,{className:"language-bash",children:"make -j12\n"})}),"\n",(0,l.jsxs)(a.ol,{start:"4",children:["\n",(0,l.jsx)(a.li,{children:"\u8fd0\u884c\u4ea7\u7269"}),"\n"]}),"\n",(0,l.jsx)(a.pre,{children:(0,l.jsx)(a.code,{className:"language-bash",children:"export LD_LIBRARY_PATH=/usr/local/lib && ./src/guacd/guacd -b 0.0.0.0 -f -L debug\n"})}),"\n",(0,l.jsx)(a.h2,{id:"\u76f8\u5173\u8d44\u6e90",children:"\u76f8\u5173\u8d44\u6e90"}),"\n",(0,l.jsxs)(a.ul,{children:["\n",(0,l.jsx)(a.li,{children:(0,l.jsx)(a.a,{href:"https://guacamole.apache.org/",children:"Guacamole"})}),"\n",(0,l.jsx)(a.li,{children:(0,l.jsx)(a.a,{href:"https://issues.apache.org/jira/browse/GUACAMOLE-2124",children:"Guacamole Issue"})}),"\n",(0,l.jsx)(a.li,{children:(0,l.jsx)(a.a,{href:"https://github.com/apache/guacamole-server/pull/614",children:"Github Pull Request"})}),"\n",(0,l.jsx)(a.li,{children:(0,l.jsx)(a.a,{href:"https://man7.org/linux/man-pages/man3/pthread_key_create.3.html",children:"man pthread key create"})}),"\n"]})]})}function h(e={}){const{wrapper:a}={...(0,c.R)(),...e.components};return a?(0,l.jsx)(a,{...e,children:(0,l.jsx)(o,{...e})}):o(e)}},28453:(e,a,n)=>{n.d(a,{R:()=>t,x:()=>s});var r=n(96540);const l={},c=r.createContext(l);function t(e){const a=r.useContext(c);return r.useMemo((function(){return"function"==typeof e?e(a):{...a,...e}}),[a,e])}function s(e){let a;return a=e.disableParentContext?"function"==typeof e.components?e.components(l):e.components||l:t(e.components),r.createElement(c.Provider,{value:a},e.children)}},39988:e=>{e.exports=JSON.parse('{"permalink":"/2025/08/28/fixing-guacamole-ssh-connection-limit-issue","source":"@site/blog/2025-08-28-fixing-guacamole-ssh-connection-limit-issue.md","title":"\u89e3\u51b3Apache Guacamole\u4e2dSSH\u8fde\u63a5\u6570\u91cf\u8d85\u8fc760\u4e2a\u4ee5\u540e\u65e0\u6cd5\u5efa\u7acb\u65b0\u8fde\u63a5\u7684\u95ee\u9898","description":"\u95ee\u9898\u63cf\u8ff0","date":"2025-08-28T00:00:00.000Z","tags":[{"inline":true,"label":"troubleshooting","permalink":"/tags/troubleshooting"},{"inline":true,"label":"guacamole","permalink":"/tags/guacamole"},{"inline":true,"label":"guacamole-server","permalink":"/tags/guacamole-server"},{"inline":true,"label":"guacd","permalink":"/tags/guacd"},{"inline":true,"label":"ssh","permalink":"/tags/ssh"},{"inline":true,"label":"linux","permalink":"/tags/linux"},{"inline":true,"label":"terminal","permalink":"/tags/terminal"},{"inline":true,"label":"c","permalink":"/tags/c"},{"inline":true,"label":"pthread","permalink":"/tags/pthread"},{"inline":true,"label":"pthread_key","permalink":"/tags/pthread-key"}],"readingTime":3.35,"hasTruncateMarker":true,"authors":[{"name":"orange","title":"programmer on jvm platform","url":"https://github.com/orange-guo","imageURL":"https://github.com/orange-guo.png","key":"orange","page":null}],"frontMatter":{"authors":["orange"],"tags":["troubleshooting","guacamole","guacamole-server","guacd","ssh","linux","terminal","c","pthread","pthread_key"]},"unlisted":false,"nextItem":{"title":"\u89e3\u51b3 Spring Boot 3.5.0 \u540e Jasypt \u65e0\u6cd5\u89e3\u6790\u73af\u5883\u53d8\u91cf\u4e2d\u7684\u52a0\u5bc6\u5b57\u7b26\u4e32\u95ee\u9898","permalink":"/2025/07/15/jasypt-spring-boot-starter-env-var-decryption-fix-spring-boot-3-5-0"}}')}}]);